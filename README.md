# ğŸ“˜ DWOJ

DWOJ æ˜¯ä¸€ä¸ªåŸºäº Node.js Express æ¡†æ¶å¼€å‘çš„è½»é‡çº§åœ¨çº¿è¯„æµ‹ç³»ç»Ÿã€‚å®ƒå…·å¤‡å®Œæ•´çš„é¢˜ç›®ç®¡ç†ã€ä»£ç è¯„æµ‹ã€è®¨è®ºåŒºã€æƒé™æ§åˆ¶åŠŸèƒ½ï¼Œå¹¶å†…ç½®äº†å¼ºå¤§çš„**æ’ä»¶ç³»ç»Ÿ**ï¼Œæ”¯æŒé«˜åº¦çš„è‡ªå®šä¹‰æ‰©å±•ã€‚

## ğŸ“‹ ç›®å½•
1. [å®‰è£…ä¸éƒ¨ç½²](#1-å®‰è£…ä¸éƒ¨ç½²)
2. [ä½¿ç”¨æ•™ç¨‹](#2-ä½¿ç”¨æ•™ç¨‹)
3. [æ’ä»¶å¼€å‘æŒ‡å—](#3-æ’ä»¶ç¼–å†™æ•™ç¨‹)

---

## 1. å®‰è£…ä¸éƒ¨ç½²

### ç¯å¢ƒè¦æ±‚
*   **Node.js**: v14.0 æˆ–æ›´é«˜ç‰ˆæœ¬
*   **Python**: Python 3.x (ç”¨äºè¯„æµ‹ Python ä»£ç )
*   **æ“ä½œç³»ç»Ÿ**: Windows / Linux / macOS å‡å¯

### ç›®å½•ç»“æ„
åœ¨å¼€å§‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„é¡¹ç›®åŒ…å«ä»¥ä¸‹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼š
```text
dwoj/
â”œâ”€â”€ data/               (è‡ªåŠ¨ç”Ÿæˆ: å­˜æ”¾æ•°æ®åº“ db.json)
â”œâ”€â”€ problems_data/      (è‡ªåŠ¨ç”Ÿæˆ: å­˜æ”¾é¢˜ç›®æµ‹è¯•ç‚¹)
â”œâ”€â”€ uploads/            (è‡ªåŠ¨ç”Ÿæˆ: ä¸´æ—¶æ–‡ä»¶ç›®å½•)
â”œâ”€â”€ plugins/            (è‡ªåŠ¨ç”Ÿæˆ: æ’ä»¶ç›®å½•)
â”œâ”€â”€ public/             (é™æ€èµ„æº)
â”œâ”€â”€ views/              (EJS é¡µé¢æ¨¡æ¿)
â”‚   â””â”€â”€ partials/       
â”œâ”€â”€ lib/                
â”‚   â””â”€â”€ plugin_system.js
â”œâ”€â”€ app.js              (ä¸»ç¨‹åº)
â””â”€â”€ package.json        (ä¾èµ–é…ç½®)
```

### å®‰è£…æ­¥éª¤

1.  **å®‰è£…ä¾èµ–**
    åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œï¼‰ï¼Œè¿è¡Œï¼š
    ```bash
    npm install
    ```

2.  **å¯åŠ¨æœåŠ¡å™¨**
    ```bash
    node app.js
    ```
    å¦‚æœçœ‹åˆ°è¾“å‡º `DWOJ 2.0 running on port 3000`ï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸã€‚

3.  **è®¿é—®ç³»ç»Ÿ**
    æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000`

4.  **åˆå§‹åŒ–ç®¡ç†å‘˜è´¦å·**
    ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è´¦å·ï¼š
    *   **ç”¨æˆ·å**: `root`
    *   **å¯†ç **: `root`
    *   *è¯·ç™»å½•åå°½å¿«ä¿®æ”¹å¯†ç ã€‚*

---

## 2. ä½¿ç”¨æ•™ç¨‹

### ğŸ‘¥ ç”¨æˆ·ä¸æƒé™
ç³»ç»Ÿæ‹¥æœ‰ä¸‰çº§æƒé™ä½“ç³»ï¼š
1.  **Default (æ™®é€šç”¨æˆ·)**: åªèƒ½åšé¢˜ã€æŸ¥çœ‹è®¨è®ºåŒºã€å‘å¸–å›å¤ã€ä¿®æ”¹ä¸ªäººèµ„æ–™ã€‚
2.  **Super User (é«˜çº§ç”¨æˆ·)**: æ‹¥æœ‰ç®¡ç†é¢æ¿æƒé™ï¼Œå¯ä»¥åˆ›å»º/ç¼–è¾‘é¢˜ç›®ã€ç®¡ç†æ’ä»¶ã€ç®¡ç†è®¨è®ºèŠ‚ç‚¹ã€å°ç¦æ™®é€šç”¨æˆ·ã€‚
3.  **Root (è¶…çº§ç®¡ç†å‘˜)**: ç³»ç»Ÿå†…ç½®è´¦å·ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ï¼Œæ— æ³•è¢«å°ç¦ï¼Œå¯ç¼–è¾‘æ‰€æœ‰é¢˜ç›®ã€‚

### ğŸ§© é¢˜ç›®ç®¡ç† (ä»… Super User/Root)
1.  **åˆ›å»ºé¢˜ç›®**:
    *   ç‚¹å‡»é¦–é¡µå³ä¸Šè§’çš„â€œ+ æ–°å»ºé¢˜ç›®â€ã€‚
    *   å¡«å†™æ ‡é¢˜ã€æè¿°ï¼ˆæ”¯æŒ Markdown å’Œ LaTeX å…¬å¼ï¼‰ã€‚
    *   **æµ‹è¯•æ•°æ®**: éœ€è¦ä¸Šä¼ ä¸€ä¸ª `.zip` å‹ç¼©åŒ…ã€‚
        *   **Zip ç»“æ„è¦æ±‚**: å‹ç¼©åŒ…å†…ç›´æ¥åŒ…å«æ•°æ®æ–‡ä»¶ï¼Œä¸è¦åŒ…å«æ–‡ä»¶å¤¹ã€‚
        *   æ–‡ä»¶å‘½å: `1.in`, `1.out`, `2.in`, `2.out` ... (è¾“å…¥è¾“å‡ºéœ€ä¸€ä¸€å¯¹åº”)ã€‚

2.  **è¯„æµ‹æœºåˆ¶**:
    *   ç³»ç»Ÿæ”¯æŒ Python 3 å’Œ Node.jsã€‚
    *   è¯„æµ‹æœºé‡‡ç”¨ç®€å•çš„æ ‡å‡†è¾“å…¥è¾“å‡ºæ¯”å¯¹ï¼ˆå¿½ç•¥è¡Œæœ«ç©ºæ ¼ï¼‰ã€‚

### ğŸ’¬ è®¨è®ºåŒº
*   æ‰€æœ‰æ³¨å†Œç”¨æˆ·å‡å¯å‘å¸ƒå¸–å­ã€‚
*   æ”¯æŒ Markdown è¯­æ³•ï¼ˆå¦‚ `**åŠ ç²—**`, `[é“¾æ¥](url)`ï¼‰ã€‚
*   æ”¯æŒ LaTeX æ•°å­¦å…¬å¼ï¼ˆå¦‚ `$E=mc^2$`, `$$\sum_{i=1}^n i$$`ï¼‰ã€‚

### ğŸ”Œ æ’ä»¶ç®¡ç†
*   å…¥å£ï¼šç™»å½•ç®¡ç†å‘˜è´¦å· -> é¡¶éƒ¨å¯¼èˆªæ â€œç®¡ç†é¢æ¿â€ -> â€œæ’ä»¶ç®¡ç†â€ã€‚
*   åŠŸèƒ½ï¼š
    *   **ä¸Šä¼ **: ä¸Šä¼  `.js` æ ¼å¼çš„æ’ä»¶æ–‡ä»¶ã€‚
    *   **å¯ç”¨/ç¦ç”¨**: åŠ¨æ€åˆ‡æ¢æ’ä»¶çŠ¶æ€ã€‚æ³¨æ„ï¼šæ¶‰åŠè·¯ç”±ï¼ˆæ–°é¡µé¢ï¼‰çš„æ’ä»¶å¯ç”¨åå»ºè®®é‡å¯æœåŠ¡å™¨ä»¥ç¡®ä¿ç¨³å®šã€‚
    *   **åˆ é™¤**: ç‰©ç†åˆ é™¤æ’ä»¶æ–‡ä»¶ã€‚

---

## 3. æ’ä»¶ç¼–å†™æ•™ç¨‹

è¯¦è§ [æ’ä»¶ç¼–å†™æ•™ç¨‹](./plugin.md)

### 3.1 æ’ä»¶åŸºæœ¬ç»“æ„
åˆ›å»ºä¸€ä¸ª `.js` æ–‡ä»¶ï¼ˆä¾‹å¦‚ `my_watchdog.js`ï¼‰ï¼Œå¹¶å¯¼å‡ºä»¥ä¸‹å¯¹è±¡ï¼š

```javascript
module.exports = {
    name: "æ’ä»¶åç§°",         // å¹¶åœ¨åå°æ˜¾ç¤º
    version: "1.0.0",       // ç‰ˆæœ¬å·
    description: "æè¿°æ–‡æœ¬", // åŠŸèƒ½ç®€ä»‹

    // --- Hooks åŒºåŸŸ ---
    
    // ç³»ç»Ÿå¯åŠ¨æˆ–æ’ä»¶å¯ç”¨æ—¶è§¦å‘
    onRoute: (app, db) => { /* ... */ },
    
    // é¡µé¢æ¸²æŸ“æ—¶è§¦å‘
    injectHeader: (req) => { /* ... */ },
    injectFooter: (req) => { /* ... */ },
    
    // è¯„æµ‹å‰åè§¦å‘
    beforeJudge: (submission, db) => { /* ... */ },
    afterJudge: (submission, db) => { /* ... */ }
};
```

### 3.2 ğŸ“š æ•°æ®ç»“æ„å‚è€ƒæ‰‹å†Œ (Data Structures)

åœ¨å¼€å‘æ’ä»¶æ—¶ï¼Œä½ ç»å¸¸éœ€è¦æ“ä½œ `db` å¯¹è±¡æˆ– `submission` å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„è¯¦ç»†å®šä¹‰ï¼š

#### 1. `db` (å…¨å±€æ•°æ®åº“å¯¹è±¡)
è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å†…å­˜æ•°æ®åº“å¼•ç”¨ã€‚**è­¦å‘Šï¼šç›´æ¥ä¿®æ”¹å®ƒä¼šç«‹å³å½±å“ç³»ç»Ÿæ•°æ®ã€‚**

```javascript
{
    users: [ User, ... ],            // ç”¨æˆ·åˆ—è¡¨
    problems: [ Problem, ... ],      // é¢˜ç›®åˆ—è¡¨
    submissions: [ Submission, ... ],// æäº¤è®°å½•åˆ—è¡¨
    discussNodes: [ Node, ... ],     // è®¨è®ºåŒºèŠ‚ç‚¹
    threads: [ Thread, ... ],        // å¸–å­åˆ—è¡¨
    plugins: {                       // æ’ä»¶å¼€å¯çŠ¶æ€
        "plugin_name.js": { enabled: true }
    }
}
```

#### 2. `User` (ç”¨æˆ·å¯¹è±¡)
```javascript
{
    id: 1,                      // [Int] ç”¨æˆ·å”¯ä¸€ID
    username: "admin",          // [String] ç”¨æˆ·å
    password: "password",       // [String] å¯†ç 
    role: "root",               // [String] æƒé™: 'default' | 'super_user' | 'root'
    bio: "Hello World",         // [String] ä¸ªäººç®€ä»‹
    tags: ["Admin", "VIP"],     // [Array<String>] ç”¨æˆ·æ ‡ç­¾
    isBanned: false             // [Boolean] æ˜¯å¦è¢«å°å·
}
```

#### 3. `Problem` (é¢˜ç›®å¯¹è±¡)
```javascript
{
    id: 1,                      // [Int] é¢˜ç›®ID
    title: "A+B Problem",       // [String] æ ‡é¢˜
    description: "## Desc...",  // [String] Markdown æ ¼å¼çš„æè¿°
    timeLimit: "1000",          // [String] æ—¶é—´é™åˆ¶(ms)
    authorId: 1                 // [Int] åˆ›å»ºè€…çš„ç”¨æˆ·ID
}
// æ³¨ï¼šæµ‹è¯•æ•°æ®å­˜å‚¨åœ¨ problems_data/{id}/ ç›®å½•ä¸‹ï¼Œä¸åœ¨ DB ä¸­
```

#### 4. `Submission` (æäº¤/è¯„æµ‹å¯¹è±¡)
è¿™æ˜¯ `beforeJudge` å’Œ `afterJudge` é’©å­ä¸­æœ€é‡è¦çš„å‚æ•°ã€‚

```javascript
{
    id: 1024,                   // [Int] æäº¤ID
    problemId: "1",             // [String] å¯¹åº”çš„é¢˜ç›®ID
    userId: 1,                  // [Int] æäº¤è€…ID
    username: "user1",          // [String] æäº¤è€…ç”¨æˆ·å
    
    language: "python",         // [String] 'python' æˆ– 'node'
    code: "print(sum(...))",    // [String] ç”¨æˆ·æäº¤çš„æºä»£ç 
    
    // --- è¯„æµ‹çŠ¶æ€ä¸ç»“æœ ---
    status: "Accepted",         
    /* 
       å¯èƒ½çš„çŠ¶æ€å€¼:
       - "Pending" (æ’é˜Ÿä¸­)
       - "Running" (æ­£åœ¨è¯„æµ‹)
       - "Accepted" (é€šè¿‡)
       - "Wrong Answer" (ç­”æ¡ˆé”™è¯¯)
       - "Time Limit Exceeded" (è¶…æ—¶)
       - "Runtime Error" (è¿è¡Œé”™è¯¯)
       - "Compilation Error" (ç¼–è¯‘é”™è¯¯ - è™½JS/Pyæ— ç¼–è¯‘ï¼Œä½†é€šç”¨æ­¤è¯)
    */

    time: "2023/1/1 12:00:00",  // [String] æäº¤æ—¶é—´å­—ç¬¦ä¸²
    
    // è¯¦ç»†çš„æµ‹è¯•ç‚¹ç»“æœ (è¯„æµ‹åç”Ÿæˆ)
    caseResults: [
        { name: "1", status: "AC" }, // ç¬¬1ä¸ªæµ‹è¯•ç‚¹é€šè¿‡
        { name: "2", status: "WA" }  // ç¬¬2ä¸ªæµ‹è¯•ç‚¹é”™è¯¯
    ],
    
    errorInfo: ""               // [String] è¿è¡Œæ—¶çš„é”™è¯¯è¾“å‡º (stderr)
}
```

---

### 3.3 API (Hooks) è¯¦è§£

#### 1. `onRoute(app, db)`
*   **è§¦å‘æ—¶æœº**: æ’ä»¶å¯ç”¨æ—¶ï¼ˆçƒ­åŠ è½½ï¼‰æˆ–æœåŠ¡å™¨é‡å¯æ—¶ã€‚
*   **ç”¨é€”**: æ·»åŠ æ–°çš„é¡µé¢è·¯ç”±æˆ– API æ¥å£ã€‚
*   **ç¤ºä¾‹**: åˆ›å»ºä¸€ä¸ª API è¿”å›å½“å‰æ€»æ³¨å†Œäººæ•°ã€‚
    ```javascript
    onRoute: (app, db) => {
        app.get('/api/user_count', (req, res) => {
            res.json({ count: db.users.length });
        });
    }
    ```

#### 2. `injectHeader(req) / injectFooter(req)`
*   **è§¦å‘æ—¶æœº**: æ¸²æŸ“ä»»æ„é¡µé¢æ—¶ã€‚
*   **å‚æ•°**: `req` (Express Request å¯¹è±¡ï¼ŒåŒ…å« `req.user` å½“å‰ç™»å½•ç”¨æˆ·)ã€‚
*   **ç”¨é€”**: æ’å…¥ CSS (Header) æˆ– JS (Footer)ã€‚
*   **ç¤ºä¾‹**: å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºä¸€ä¸ªçº¢è‰²è¾¹æ¡†ã€‚
    ```javascript
    injectHeader: (req) => {
        if (req.user && req.user.role === 'root') {
            return `<style>body { border-top: 5px solid red; }</style>`;
        }
        return "";
    }
    ```

#### 3. `beforeJudge(submission, db)`
*   **è§¦å‘æ—¶æœº**: è¯„æµ‹æœºå¯åŠ¨**ä¹‹å‰**ã€‚
*   **ç”¨é€”**: 
    *   **ä»£ç å®¡æŸ¥**: æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦åŒ…å«æ¶æ„å…³é”®å­—ï¼ˆå¦‚ `child_process`, `os.system`ï¼‰ã€‚
    *   **è¯­è¨€é™åˆ¶**: ç¦æ­¢æŸäº›è¯­è¨€æäº¤ã€‚
*   **ç¤ºä¾‹**: ç®€å•çš„æ¶æ„ä»£ç æ‹¦æˆªå™¨ã€‚
    ```javascript
    beforeJudge: (sub, db) => {
        const blackList = ['require("child_process")', 'import os', 'exec('];
        for (const word of blackList) {
            if (sub.code.includes(word)) {
                sub.code = ""; // æ¸…ç©ºä»£ç 
                sub.status = "Compilation Error"; // æ ‡è®°ä¸ºé”™è¯¯
                sub.errorInfo = "Security Check Failed: Malicious code detected.";
                // æ³¨æ„ï¼šè¿™é‡Œè™½ç„¶æ”¹äº†çŠ¶æ€ï¼Œä½†å¤–å±‚è¯„æµ‹å‡½æ•°å¯èƒ½è¿˜ä¼šè·‘ï¼Œ
                // å®é™…ç”Ÿäº§ä¸­é€šå¸¸æŠ›å‡ºå¼‚å¸¸ä¸­æ–­ï¼Œä½†åœ¨æœ¬ç®€æ˜“ç³»ç»Ÿä¸­æ”¹å†™ code ä¸ºç©ºå³å¯è®©è¯„æµ‹å¤±è´¥ã€‚
            }
        }
    }
    ```

#### 4. `afterJudge(submission, db)`
*   **è§¦å‘æ—¶æœº**: è¯„æµ‹å®Œæˆ**ä¹‹å**ã€‚
*   **ç”¨é€”**: ç»Ÿè®¡æ•°æ®ã€å‘æ”¾å¾½ç« ã€è®°å½•æ—¥å¿—ã€‚
*   **ç¤ºä¾‹**: æ‰“å°æ—¥å¿—ã€‚
    ```javascript
    afterJudge: (sub, db) => {
        if (sub.status === 'Accepted') {
            console.log(`[PLUGIN LOG] User ${sub.username} AC Problem ${sub.problemId}`);
        }
    }
    ```

### å®æˆ˜ï¼šç¼–å†™ä¸€ä¸ªâ€œå…¬å‘Šæ¿â€æ’ä»¶

å°†ä»¥ä¸‹ä»£ç ä¿å­˜ä¸º `notice_plugin.js` å¹¶ä¸Šä¼ ï¼Œå³å¯åœ¨æ¯ä¸ªé¡µé¢é¡¶éƒ¨æ˜¾ç¤ºä¸€æ¡å…¬å‘Šã€‚

```javascript
module.exports = {
    name: "Global Notice",
    version: "1.0",
    description: "åœ¨æ‰€æœ‰é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå…¬å‘Š",

    injectHeader: (req) => {
        // å¯ä»¥åœ¨è¿™é‡Œå†™ CSS ç¾åŒ–å…¬å‘Šæ 
        return `
        <style>
            .plugin-notice {
                background: #ffecb3;
                color: #663c00; // æ·±æ£•è‰²
                text-align: center;
                padding: 10px;
                border-bottom: 1px solid #e6c300;
                font-weight: bold;
            }
        </style>
        `;
    },

    injectFooter: (req) => {
        // ä½¿ç”¨ JS å°†å…¬å‘Šæ’å…¥åˆ°å¯¼èˆªæ ä¸‹æ–¹
        // æ³¨æ„ï¼šè¿™é‡Œä¾èµ–é¡µé¢åŸæœ¬çš„ DOM ç»“æ„ï¼Œå¦‚æœæ¨¡æ¿å˜äº†å¯èƒ½éœ€è¦è°ƒæ•´
        return `
        <script>
            const noticeDiv = document.createElement('div');
            noticeDiv.className = 'plugin-notice';
            noticeDiv.innerHTML = 'ğŸ“¢ ç³»ç»Ÿç»´æŠ¤é€šçŸ¥ï¼šæœ¬å‘¨æ—¥å‡Œæ™¨å°†è¿›è¡ŒæœåŠ¡å™¨å‡çº§ã€‚';
            // æ’å…¥åˆ° body çš„æœ€å‰é¢ï¼Œæˆ–è€…ç‰¹å®šå¯¼èˆªæ åé¢
            document.body.prepend(noticeDiv);
        </script>
        `;
    }
};
```